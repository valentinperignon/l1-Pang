<!doctype html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Pang</title>
    <script>

    // ------------------------------
    //  Variables
    // ------------------------------

    // Context
    var context = null;

    // Is the game running or not ?
    var isOnFocus = true;
    var pause = false;

    // A ballon
    // With the position, the radius, the velocity and the gravity for this ballon. Plus his color because it is beautiful.
    var ballon = {center: {x: 0, y:0}, radius:50, velocity:{ x: 1, y: 0}, gravity: {x :0, y: 9.81/1000}, color:"red"};
    const BALLON_SPEED = 0.2;

    // when did we update the game last time ?
    var lastUpdate = Date.now();

    // A beautiful player
    // With his position, his speed, his size and his others variables
    var player = {position: {x: 0, y: 0}, speed: {x: 0, y: 0}, height: 0, width: 0, powerOn: 0, shieldOn: 0, score: 0, livesNumber: 3};
    const PLAYER_SPEED = 500;

    // gravity (thanks Newton)
    const GRAVITY = {x: 0, y: 9.81};

    // platforms in the game
	var platform = [];
	const PLATFORM_SIZE = 40;
	var numLevel = 1;



    // ------------------------------
    //  Functions
    // ------------------------------

    // Moving the player horizontally
    playerMove = function(move) {

        if(move == 39) {
            player.speed.x = PLAYER_SPEED;
        } else {
            if(move == 37) {
                player.speed.x = -PLAYER_SPEED;
            }
        }
    }

    playerStopMove = function(move) {
        if(move == 39 || move == 37) {
            player.speed.x = 0;
        }
    }

    // It does exactly what you expect
    keepPlayerWithinBorder = function() {
        if(player.position.x < 0) {
            player.position.x = 0;
        } else {
            if(player.position.x > context.width-player.width) {
                player.position.x = context.width-player.width
            }
        }

        if(player.position.y < 0) {
            player.position.y = 0;
        } else {
            if(player.position.y > context.height-player.height) {
                player.position.y = context.height-player.height
            }
        }
    }

    // It does exactly what you expect
    function keepBallonWithinBorders(ballon){
        //Top
        if(ballon.center.y < ballon.radius){
            ballon.center.y = ballon.radius;
            ballon.velocity.y = -ballon.velocity.y;
        } else {
            //Bottom
            if(ballon.center.y > cvs.height - ballon.radius){
                ballon.center.y = cvs.height - ballon.radius;
                ballon.velocity.y = -ballon.velocity.y;
            }
        }
        //Left
        if(ballon.center.x < ballon.radius){
            ballon.center.x = ballon.radius;
            ballon.velocity.x = -ballon.velocity.x;
        } else {
            //Right
            if(ballon.center.x > cvs.width-ballon.radius){
                ballon.center.x = cvs.width - ballon.radius;
                ballon.velocity.x = -ballon.velocity.x;
            }
        }
        return(ballon);
    }

    // like FillRect, but for circles
    function fillCircle(circle){
        var canvas = document.getElementById("cvs");
        var context = canvas.getContext("2d");
        context.beginPath();
        context.fillStyle=circle.color
        context.arc(circle.center.x, circle.center.y, circle.radius, 0, 2 * Math.PI);
        context.fill();
    }

    // Is the ballonX between the x and (x + width) of the rectangle ? Return boolean
    // Inputs : ballon with x, rectangle with x and width
    function isBetweenX(ballonCenter,rectangle){
        return(ballonCenter.x > rectangle.x && ballonCenter.x < rectangle.x + rectangle.width)
    }

    // Is the ballonY between the y and (y + width) of the rectangle ? Return boolean
    // Inputs : ballon with y, rectangle with y and height
    function isBetweenY(ballonCenter,rectangle){
        return(ballonCenter.y > rectangle.y && ballonCenter.y < rectangle.y + rectangle.height)
    }

    // manage the collisions between ballons and objects defined by rectangles
    /*function collisionsWithRectangles(ballon, rectangle) {
        return !(rectangle.x + rectangle.width =< ballon.center.x - ballon.radius ||
                rectangle.x >= ballon.center.x + ballon.radius ||
                rectangle.y + player.height =< ballon.center.y - ballon.radius ||
                rectangle.y >= ballon.center.y + ballon.radius ||
                if(isBetweenX(ballon.center, player.position)){
                    rectangle.y >= ballon.center.y + ballon.radius ||
                    rectangle.y + rectangle.height <= ballon.center.y - ballon.radius
                }
                if(isBetweenY(ballon.center, player.position)){
                    rectangle.x >= ballon.center.x + ballon.radius ||
                    rectangle.x + rectangle.width <= ballon.center.x - ballon.radius 
                };)
    }*/

    function collisionsWithPlayer(ballon, player) {
        var collisionCoin = true;
        var collisionsY = false;
        var collisionX = false;
        if(
            player.position.x + player.width <= ballon.center.x - ballon.radius || 
            player.position.x >= ballon.center.x + ballon.radius || 
            player.position.y + player.height <= ballon.center.y - ballon.radius || 
            player.position.y >= ballon.center.y + ballon.radius)
        { 
            collisionCoin = false;
        }
        if(isBetweenX(ballon.center, player.position)){
            if(player.position.y >= ballon.center.y + ballon.radius ||
                player.position.y + player.height <= ballon.center.y - ballon.radius)
            {
                collisionsY = true;
            } 
        } 
        if(isBetweenY(ballon.center, player.position)){
            if(player.position.x >= ballon.center.x + ballon.radius ||
            player.position.x + player.width <= ballon.center.x - ballon.radius )
            {
                collisionX = true;
            }
        }
        return(collisionCoin || collisionX || collisionsY);  
    }

    /*function collisionsWithBalloons(balloons[1], balloons[2]){
        return(Math.pow(balloons[1].radius + balloons[2].radius, 2) <= Math.pow(balloons[1].position.x - balloons[2].position.x, 2) + Math.pow(balloons[1].position.y - balloons[2].position.y, 2))

    }*/

    // ------------------------------
    //  Game
    // ------------------------------

    /**
    * Initialization of the game
    */
  

	
	
    // initialisation (appelée au chargement du corps du document <body onload="init">)
    init = function() {
       
       // Initizalisation of the global var context
        context = document.getElementById("cvs").getContext("2d");
        context.width = document.getElementById("cvs").width;
        context.height = document.getElementById("cvs").height;

        //Pause if it is not on focus
        document.body.onblur = function() {
            isOnFocus = false;
        }
        document.body.onfocus = function() {
            isOnFocus = true;
        }



		//Creation des plateformes horizontale
		switch(numLevel){
			case 1 :{
				for (var i=0; i < 4; i++) {
					platform[i] = {
									x: Math.floor(context.width-(i+1)*150-75),
				      				y: Math.floor(context.height/2-100),				
				        			width: PLATFORM_SIZE*2,
				        			height: PLATFORM_SIZE,
									vertical: false,
                                    exist: true
                    };  
				}
			break;
			}
        }

        // The ballon is in the middle top
        ballon.center.x = cvs.width/2;
        ballon.center.y =  ballon.radius + 2;

        // 2 listeners on the keyboard (keyup and keydown)
        document.addEventListener("keydown", captureKeyboardPress)
        document.addEventListener("keyup", captureKeyboardReleased)

        // initialization of the player
        player.height = 75;
        player.width = 75;
        player.position.x = context.width/2 - player.width/2;
        player.position.y = context.height - player.height;

        // Go my little game loop, and never stop
        gameLoop();
    }

    /**
    * Game loop
    */
    gameLoop = function() {
        var delta = Date.now()-lastUpdate;
        lastUpdate = Date.now();

        // Run the game if it is not on pause
        if(!isOnFocus || pause){
            document.title = "Pang - en pause";
        } else {
            document.title = "Pang";

            // update of the game's state
            update(delta);
            // draw the game
            render();
        }

        requestAnimationFrame(gameLoop);

    }


    /**
    *  Game update
    *  @param delta the time between now and the last update
    */
    update = function(delta) {
        
        // Update ballon.velocity
        ballon.velocity.x += ballon.gravity.x*delta;
        ballon.velocity.y += ballon.gravity.y*delta;

        // Update ballon.center
        ballon.center.x += ballon.velocity.x * delta * BALLON_SPEED;
        ballon.center.y += ballon.velocity.y * delta * BALLON_SPEED;
    

        if(collisionsWithPlayer(ballon, player)){
            pause = true;
        }
        
        
        //No, you will not stick out
        keepBallonWithinBorders(ballon);


        // Move the player
        var newPosXPlayer = player.position.x + player.speed.x*delta/1000, newPosYPlayer = player.position.y + player.speed.y*delta/1000;
        var newSpdXPlayer = player.speed.x + GRAVITY.x*delta/1000, newSpdYPlayer = player.speed.y + GRAVITY.y*delta/1000;
        player.position.x = newPosXPlayer;
        player.position.y = newPosYPlayer;
        player.speed.x = newSpdXPlayer;
        player.speed.y = newSpdYPlayer;
        keepPlayerWithinBorder();
    }

    /**
    *  Game render
    */
    render = function() {
        // Wiping the screen
        context.clearRect(0, 0, context.width, context.height);


        // Ballon displaying
        fillCircle(ballon);

        // Drawing of the player
        context.fillStyle = "blue";
        context.fillRect(player.position.x, player.position.y, player.height, player.width);
    
	
		// platforms drawing
        context.fillStyle="black";
        for (var i=0; i < platform.length; i++) {
        	context.fillRect(platform[i].x, platform[i].y, platform[i].width, platform [i].height);
        }
    }



    /**
    *  Key down event
    */
    captureKeyboardPress = function(event) {
        switch (event.keyCode) {
            // Player1 left or right
            case 39:
            case 37:
                playerMove(event.keyCode);
            break;

            // P means pause or unpause
            case 80:
                pause = !pause;
            break;

        }
    }

    /**
    *  Key up event
    */
    captureKeyboardReleased = function(event) {
        switch (event.keyCode) {
            //Player1 left or right
            case 39:
            case 37:
                playerStopMove(event.keyCode);
            break;
        }
    }

	

    </script>
</head>

<body onload="init()">

    <canvas id="cvs" width="800" height="600" style="margin: 10px auto; border: solid 1px #000;"></canvas>

</body>

</html>
